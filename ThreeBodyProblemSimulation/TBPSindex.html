<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>三体問題シミュレーション</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            transition: background-color 0.3s, color 0.3s;
        }
        #simulationCanvas {
            border: 1px solid #000;
            margin-bottom: 20px;
        }
        .controls {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
        }
        .control-group {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        button {
            padding: 5px 10px;
            cursor: pointer;
        }
        .dark-mode {
            background-color: #333;
            color: #fff;
        }
        .dark-mode #simulationCanvas {
            border-color: #fff;
        }
    </style>
</head>
<body>
    <h1>三体問題シミュレーション</h1>
    <canvas id="simulationCanvas" width="800" height="600"></canvas>
    <div class="controls">
        <div class="control-group">
            <label for="massSlider">質量: <span id="massValue">1e30</span> kg</label>
            <input type="range" id="massSlider" min="1e29" max="1e30" step="1e29" value="1e30">
        </div>
        <div class="control-group">
            <label for="velocitySlider">初速: <span id="velocityValue">30</span> km/s</label>
            <input type="range" id="velocitySlider" min="0" max="100" step="1" value="30">
        </div>
        <div class="control-group">
            <label for="dtSlider">時間刻み: <span id="dtValue">3600</span> 秒</label>
            <input type="range" id="dtSlider" min="1800" max="7200" step="100" value="3600">
        </div>
    </div>
    <div class="controls">
        <button id="resetBtn">リセット</button>
        <button id="pauseResumeBtn">一時停止/再開</button>
        <button id="toggleTrailBtn">軌跡表示切替</button>
        <button id="toggleThemeBtn">テーマ切替</button>
    </div>
    <div id="energyInfo"></div>

    <script>
        const canvas = document.getElementById('simulationCanvas');
        const ctx = canvas.getContext('2d');
        let isPaused = false;
        let showTrail = false;
        let isDarkMode = false;

        const G = 6.67430e-11; // 重力定数
        const SCALE = 1e-9; // スケーリング係数
        const AU = 1.496e11; // 1天文単位（メートル）

        class Body {
            constructor(x, y, mass, vx, vy, color) {
                this.x = x * AU;
                this.y = y * AU;
                this.mass = mass;
                this.vx = vx * 1000; // km/s to m/s
                this.vy = vy * 1000; // km/s to m/s
                this.color = color;
                this.trail = [];
            }

            update(bodies, dt) {
                let fx = 0, fy = 0;
                for (let body of bodies) {
                    if (body !== this) {
                        let dx = body.x - this.x;
                        let dy = body.y - this.y;
                        let distSq = dx * dx + dy * dy;
                        let dist = Math.sqrt(distSq);
                        let f = (G * this.mass * body.mass) / distSq;
                        fx += f * dx / dist;
                        fy += f * dy / dist;
                    }
                }
                this.vx += fx / this.mass * dt;
                this.vy += fy / this.mass * dt;
                this.x += this.vx * dt;
                this.y += this.vy * dt;

                if (showTrail) {
                    this.trail.push({x: this.x * SCALE, y: this.y * SCALE});
                    if (this.trail.length > 1000) {
                        this.trail.shift();
                    }
                }
            }

            draw() {
                let scaledX = this.x * SCALE;
                let scaledY = this.y * SCALE;
                ctx.fillStyle = this.color;
                ctx.beginPath();
                ctx.arc(scaledX, scaledY, Math.sqrt(this.mass) * 1e-13, 0, 2 * Math.PI);
                ctx.fill();

                if (showTrail) {
                    ctx.strokeStyle = this.color;
                    ctx.beginPath();
                    for (let point of this.trail) {
                        ctx.lineTo(point.x, point.y);
                    }
                    ctx.stroke();
                }
            }
        }

        let bodies = [];

        function initBodies() {
            const mass = parseFloat(document.getElementById('massSlider').value);
            const velocity = parseFloat(document.getElementById('velocitySlider').value);
            bodies = [
                new Body(0, 0, mass, 0, velocity, 'red'),
                new Body(1, 0, mass, -velocity * Math.cos(Math.PI/6), velocity * Math.sin(Math.PI/6), 'blue'),
                new Body(-0.5, 0.866, mass, velocity * Math.cos(Math.PI/6), -velocity * Math.sin(Math.PI/6), 'green')
            ];
        }

        function calculateEnergy() {
            let kineticEnergy = 0;
            let potentialEnergy = 0;
            for (let i = 0; i < bodies.length; i++) {
                const body1 = bodies[i];
                kineticEnergy += 0.5 * body1.mass * (body1.vx * body1.vx + body1.vy * body1.vy);
                for (let j = i + 1; j < bodies.length; j++) {
                    const body2 = bodies[j];
                    const dx = body2.x - body1.x;
                    const dy = body2.y - body1.y;
                    const distance = Math.sqrt(dx * dx + dy * dy);
                    potentialEnergy -= G * body1.mass * body2.mass / distance;
                }
            }
            return kineticEnergy + potentialEnergy;
        }

        function simulate() {
            if (!isPaused) {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                const dt = parseFloat(document.getElementById('dtSlider').value);
                for (let body of bodies) {
                    body.update(bodies, dt);
                    body.draw();
                }
                const totalEnergy = calculateEnergy();
                document.getElementById('energyInfo').textContent = `全エネルギー: ${totalEnergy.toExponential(4)} J`;
            }
            requestAnimationFrame(simulate);
        }

        function resetSimulation() {
            initBodies();
            for (let body of bodies) {
                body.trail = [];
            }
        }

        function togglePauseResume() {
            isPaused = !isPaused;
            document.getElementById('pauseResumeBtn').textContent = isPaused ? '再開' : '一時停止';
        }

        function toggleTrail() {
            showTrail = !showTrail;
            document.getElementById('toggleTrailBtn').textContent = showTrail ? '軌跡を隠す' : '軌跡を表示';
            if (!showTrail) {
                for (let body of bodies) {
                    body.trail = [];
                }
            }
        }

        function toggleTheme() {
            isDarkMode = !isDarkMode;
            document.body.classList.toggle('dark-mode', isDarkMode);
            document.getElementById('toggleThemeBtn').textContent = isDarkMode ? 'ライトモード' : 'ダークモード';
        }

        document.getElementById('resetBtn').addEventListener('click', resetSimulation);
        document.getElementById('pauseResumeBtn').addEventListener('click', togglePauseResume);
        document.getElementById('toggleTrailBtn').addEventListener('click', toggleTrail);
        document.getElementById('toggleThemeBtn').addEventListener('click', toggleTheme);

        document.getElementById('massSlider').addEventListener('input', function() {
            document.getElementById('massValue').textContent = this.value;
        });
        document.getElementById('velocitySlider').addEventListener('input', function() {
            document.getElementById('velocityValue').textContent = this.value;
        });
        document.getElementById('dtSlider').addEventListener('input', function() {
            document.getElementById('dtValue').textContent = this.value;
        });

        initBodies();
        simulate();
    </script>
</body>
</html>
